From: Erik Johnston <erikj@matrix.org>
Date: Mon, 2 Oct 2017 14:57:39 +0100
Subject: Remove affinity package requirement

---
 synapse/app/_base.py           | 10 +++++++++-
 synapse/python_dependencies.py |  1 -
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/synapse/app/_base.py b/synapse/app/_base.py
index e1ff8f9..cfc2489 100644
--- a/synapse/app/_base.py
+++ b/synapse/app/_base.py
@@ -15,7 +15,10 @@
 import gc
 import logging
 
-import affinity
+try:
+    import affinity
+except:
+    affinity = None
 from daemonize import Daemonize
 from synapse.util import PreserveLoggingContext
 from synapse.util.rlimit import change_resource_limit
@@ -78,6 +81,11 @@ def start_reactor(
         with PreserveLoggingContext():
             logger.info("Running")
             if cpu_affinity is not None:
+                if not affinity:
+                    quit_with_error(
+                        "Cannot use cpu_affinity config option with manually\n"
+                        "installing the python affinity pacakge\n\n"
+                    )
                 logger.info("Setting CPU affinity to %s" % cpu_affinity)
                 affinity.set_process_affinity_mask(0, cpu_affinity)
             change_resource_limit(soft_file_limit)
diff --git a/synapse/python_dependencies.py b/synapse/python_dependencies.py
index 4cc1ba2..029465a 100644
--- a/synapse/python_dependencies.py
+++ b/synapse/python_dependencies.py
@@ -40,7 +40,6 @@ REQUIREMENTS = {
     "pymacaroons-pynacl": ["pymacaroons"],
     "msgpack-python>=0.3.0": ["msgpack"],
     "phonenumbers>=8.2.0": ["phonenumbers"],
-    "affinity": ["affinity"],
 }
 CONDITIONAL_REQUIREMENTS = {
     "web_client": {
